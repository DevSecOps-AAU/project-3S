name: CI/CD with Docker Compose

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: [self-hosted, server]

    steps:
      # Step 1: Checkout the code from GitHub repository
      - name: ğŸ› ï¸ Checkout code
        uses: actions/checkout@v4
 
      # Step 3: Set up Docker Buildx
      - name: ğŸ”§ Set up Docker
        uses: docker/setup-buildx-action@v3

      # Step 5: Build and push Docker image using docker-compose
      - name: ğŸ³ Build Docker Compose services
        uses: docker/build-push-action@v3
        with:
          context: . # path to folder containing docker-compose.yml
          file: dockerfile  # if you have a Dockerfile
          push: false  # set true if you want to push to DockerHub
          platforms: linux/amd64,linux/arm64


  deploy:
    runs-on: [self-hosted, server]
    needs: build  # Ensure this runs after the 'build' job

    steps:
      # Step 1: Checkout the code again for deployment
      - name: ğŸ› ï¸ Checkout code for deployment
        uses: actions/checkout@v4

      # Step 2: Set up Docker on the server (optional step for deployment)
      - name: ğŸ”§ Set up Docker for deployment
        run: |
          curl -fsSL https://get.docker.com | bash
          sudo usermod -aG docker $USER
          sudo systemctl enable --now docker

      # Step 3: SSH into the server and deploy (Replace with your actual server details)
      - name: ğŸš€ Deploy to Production (SSH to server)
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVERIP }} 
          username: "cybersecurity" 
          script: |
            cd ./sadeel-heba/project3
            docker-compose -f ./sadeel-heba/project3/docker-compose.yml down  # Stop old containers (if any)
            docker-compose -f ./sadeel-heba/project3/docker-compose.yml up -d --build  # Build and start new containers

      # Optional: Post-deployment steps (e.g., notify, or health check)
      - name: âœ… Health Check (Optional)
        run: |
          curl --fail http://localhost:3000 || exit 1  # Check if the app is running
